/*! JavaScript Library to Create Custom Builds For Front-End Projects - v0.6.0 - 2012-12-12
* https://github.com/gfranko/DownloadBuilder.js
* Copyright (c) 2012 Greg Franko; Licensed MIT */
(function(e){"use strict";e(window,document)})(function(e,t,n){"use strict";var r=function(e){this.options={location:e&&e.location||"local",author:e&&e.author||"",repo:e&&e.repo||"",branch:e&&e.branch||"",client_id:e&&e.client_id||"",client_secret:e&&e.client_secret||""},e&&e.cache!==n?this.options.cache=+e.cache:this.options.cache=36e5,this._create()};r.prototype={VERSION:"0.6.0",githubRateLimitUrl:"https://api.github.com/rate_limit",file:"",currentCheckbox:0,checkboxes:[],callback:function(){},_create:function(){return this.supportsFilesystem=this.fileSystemSupport(),this.github=this._isUsingGithub(),this.github.isUsing&&this._checkGithubRateLimit(),this},fileSystemSupport:function(){return e.requestFileSystem=e.requestFileSystem||e.webkitRequestFileSystem||e.mozRequestFileSystem,e.URL=e.URL||e.webkitURL||e.mozURL,e.storageInfo=e.storageInfo||e.webkitStorageInfo||e.mozStorageInfo,!e.requestFileSystem||!e.Blob||!e.URL||!e.storageInfo?!1:!0},_isUsingGithub:function(){var e=t.querySelectorAll('[data-location="github"]');return e.length||this.options.location==="github"?{isUsing:!0,length:e.length}:{isUsing:!1,length:e.length}},_checkGithubRateLimit:function(){var e=this;return this.JSONP(this.githubRateLimitUrl+"?client_id="+this.options.client_id+"&client_secret="+this.options.client_secret,function(t){e.rateLimit=t.data.rate.remaining}),this},JSONP:function(r,i,s){r=r||"",i=i||"",s=s||function(){};var o,u;typeof i=="function"&&(s=i,i="callback"),u="jsonp"+Math.round(Math.random()*1000001),e[u]=function(t){s(t);try{delete e[u]}catch(r){e[u]=n}},r.indexOf("?")===-1?r+="?":r+="&",o=t.createElement("script"),o.setAttribute("src",r+i+"="+u),t.getElementsByTagName("head")[0].appendChild(o)},buildURL:function(t,n,r,i){if(t.length){var s=this,o=(new Date).getTime(),u,a,f,l,c,h,p,d;typeof i=="function"&&(s.callback=i),s.currentCheckbox===0&&e.sessionStorage&&!e.sessionStorage.getItem("cache-time")&&e.sessionStorage.setItem("cache-time",o),s.checkboxes=t,d=s.currentCheckbox===t.length-1||!1,u=t[s.currentCheckbox],a=u.getAttribute("data-location")||s.options.location||"",f=u.getAttribute("data-author")||s.options.author||"",l=u.getAttribute("data-repo")||s.options.repo||"",c=u.getAttribute("data-branch")||s.options.branch||"",h=u.getAttribute("data-localpath")||"",e.sessionStorage&&(e.sessionStorage.getItem(u.value)&&e.sessionStorage.getItem("cache-time")?o-e.sessionStorage.getItem("cache-time")>=s.options.cache?(e.sessionStorage.removeItem(u.value),e.sessionStorage.removeItem("cache-time"),s._sendRequest({location:a,repoAuthor:f,repoName:l,repoBranch:c,localPath:h,currentElem:u,time:o,lastElem:d,fileName:n,lang:r})):(s.file+=e.sessionStorage.getItem(u.value),s._fileStatus({lastElem:d,lang:r,fileName:n})):s._sendRequest({location:a,repoAuthor:f,repoName:l,repoBranch:c,localPath:h,currentElem:u,time:o,lastElem:d,fileName:n,lang:r}))}else i.call(e,{content:"",fileName:n,lang:r});return this},_localRequest:function(t){var n=this,r,i;try{r=new XMLHttpRequest,r.open("GET",t.url,!0),r.onreadystatechange=function(r){this.readyState===4&&this.status===200&&(i=this.responseText||this.response||"",n.file?n.file+="\n"+i:n.file+=i,e.sessionStorage.setItem(t.elem.value,i||""),n._fileStatus({lastElem:t.lastElem,lang:t.lang,fileName:t.fileName}))},r.send()}catch(s){}return this},_thirdPartyRequest:function(t){var n=this,r;this.JSONP(t.url,function(i){t.type==="github"&&(r=n._parseGithubResponse({elem:t.elem,data:i})||"",n.file?n.file+="\n"+r:n.file+=r,e.sessionStorage.setItem(t.elem.value,r||""),n._fileStatus({lastElem:t.lastElem,lang:t.lang,fileName:t.fileName}))})},_sendRequest:function(e){e.location==="github"?this.rateLimit!==0?(this.rateLimit-=1,this._thirdPartyRequest({type:e.location,url:"https://api.github.com/repos/"+e.repoAuthor+"/"+e.repoName+"/contents/?ref="+e.repoBranch+"&path="+e.currentElem.value+"&client_id="+this.options.client_id+"&client_secret="+this.options.client_secret,elem:e.currentElem,time:e.time,lastElem:e.lastElem,lang:e.lang,fileName:e.fileName})):e.localPath&&this._localRequest({url:e.localpath,elem:e.currentElem,time:e.time,lastElem:e.lastElem,lang:e.lang,fileName:e.fileName}):this._localRequest({url:e.currentElem.value,elem:e.currentElem,time:e.time,lastElem:e.lastElem,lang:e.lang,fileName:e.fileName})},_parseGithubResponse:function(t){var r=this,i,s,o,u;return t.data.data.content!==n&&e.atob&&t.data.data.encoding==="base64"&&(i=t.data.data.content,i=i.replace(/\n/g,""),s=e.atob(i),o=s.split("\n"),u=o.slice(0,o.length).join("\n")||""),u},createURL:function(t){var n=this,r;return e.storageInfo.requestQuota(e.TEMPORARY,1048576,function(i){e.requestFileSystem(n.storageType,i,function(n){n.root.getFile(t.fileName,{create:!0},function(n){n.createWriter(function(n){r=new e.Blob([t.data],{type:"text/"+t.lang}),t.callback.call(e,e.URL.createObjectURL(r))})})})}),this},_fileStatus:function(t){var n=this,r;return t.lastElem?(this.currentCheckbox=0,n.supportsFilesystem?n.createURL({lang:t.lang,fileName:t.fileName,data:n.file,callback:function(r){e.sessionStorage.setItem("bloburl",r),n.callback.call(e,{url:r,content:n.file,fileName:t.fileName,lang:t.lang}),n.file=""}}):(n.callback.call(e,{content:n.file,fileName:t.fileName,lang:t.lang}),n.file="")):(this.currentCheckbox+=1,n.buildURL(n.checkboxes,t.fileName,t.lang,n.callback)),this}},e.DownloadBuilder=r});